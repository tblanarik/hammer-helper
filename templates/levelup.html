{% extends 'base.html' %}
{% block content %}
<h2 class="mb-4">Skill Level-Up Tool</h2>
<form method="post" class="bg-secondary bg-opacity-10 p-4 rounded shadow mb-4" id="levelupForm">
	<div class="row g-3">
		<div class="col-12">
			<label class="form-label fw-bold">Select Skills to Level Up</label>
			<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-2">
				{% for skill in skills %}
				<div class="form-check col">
					<input class="form-check-input" type="checkbox" name="skills" id="skill_{{ loop.index }}" value="{{ skill }}" onchange="toggleSkillFields('{{ skill }}', this.checked)">
					<label class="form-check-label" for="skill_{{ loop.index }}">{{ skill }}</label>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
	<div id="skillsDetails" class="mt-4"></div>
	<div class="mt-4">
		<button type="submit" class="btn btn-warning fw-bold">Level Up!</button>
		<a href="?clear=1" class="btn btn-outline-secondary ms-2">Clear Results</a>
	</div>
</form>
<script>
function toggleSkillFields(skill, checked) {
	const detailsDiv = document.getElementById('skillsDetails');
	let skillId = 'details_' + skill.replace(/[^a-zA-Z0-9]/g, '_');
	if (checked) {
		// Prevent duplicate fields for the same skill
		if (!document.getElementById(skillId)) {
			let html = `<div class='row g-2 align-items-end mb-2' id='${skillId}'>
				<div class='col-12 col-md-3'><strong>${skill}</strong></div>
				<div class='col-6 col-md-2'>
					<label class='form-label mb-0'>Current Level</label>
					<input type='number' class='form-control bg-dark text-light border-warning' name='level_${skill}' min='0' max='100' value='0' required>
				</div>
				<div class='col-6 col-md-2'>
					<label class='form-label mb-0'>Career?</label>
					<input type='checkbox' class='form-check-input ms-2' name='career_${skill}'>
				</div>
				<div class='col-12 col-md-3'>
					<label class='form-label mb-0'>Advancement Checks</label>
					<select class='form-select bg-dark text-light border-warning' name='checks_${skill}'>
						<option value='1'>1</option>
						<option value='2'>2</option>
					</select>
				</div>
			</div>`;
			detailsDiv.insertAdjacentHTML('beforeend', html);
		}
	} else {
		// Remove fields for this skill
		let el = document.getElementById(skillId);
		if (el) el.remove();
	}
}
// Always attach event listeners for skill checkboxes

document.addEventListener('DOMContentLoaded', function() {
	document.querySelectorAll('input[name="skills"]').forEach(cb => {
		cb.addEventListener('change', function() {
			toggleSkillFields(cb.value, cb.checked);
		});
	});
});
</script>

{% if report %}
<div class="alert alert-success mt-4">
	<h5>Level-Up Results</h5>
	<div class="table-responsive">
	<table class="table table-dark table-bordered align-middle">
		<thead>
			<tr>
				<th>Skill</th>
				<th>Current Level</th>
				<th>Career?</th>
				<th>Checks</th>
				<th>1d100 Roll</th>
				<th>Result</th>
				<th>Level Up Dice</th>
				<th>Level Up Roll</th>
				<th>New Level</th>
			</tr>
		</thead>
		<tbody>
		{% for r in report %}
			<tr>
				<td>{{ r.skill }}</td>
				<td>{{ r.current_level }}</td>
				<td>{% if r.career %}<span class="text-success">✔️</span>{% else %}<span class="text-danger">❌</span>{% endif %}</td>
				<td>{{ r.checks }}</td>
				<td>{{ r.roll_1d100 }}</td>
				<td>{% if r.passed %}<span class="text-success">✔️ Success</span>{% else %}<span class="text-danger">❌ Fail</span>{% endif %}</td>
				<td>1d{{ r.die }}</td>
				<td>{% if r.adv_roll is not none %}{{ r.adv_roll }}{% else %}-{% endif %}</td>
				<td>{% if r.new_level == 69 %}69 (Nice){% else %}{{ r.new_level }}{% endif %}</td>
			</tr>
		{% endfor %}
		</tbody>
	</table>
	</div>
</div>
{% endif %}
{% endblock %}
